<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading live class details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <div class="error-icon">❌</div>
      <h3>Error Loading Class</h3>
      <p>{{ error }}</p>
      <button class="retry-btn" (click)="loadLiveClassDetails()">Try Again</button>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && !error && liveClass" class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <button class="close-btn" (click)="closeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Hero Section -->
      <div class="hero-section">
        <div class="cover-image-container">
          <img 
            [src]="getSafeImageUrl(liveClass.coverImage, 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=800&h=400&fit=crop&auto=format&q=80')"
            [alt]="liveClass.title"
            class="cover-image loading"
            (load)="onImageLoad($event)"
            (loadstart)="onImageLoadStart($event)"
            (error)="onImageError($event)">
          <div class="hero-overlay">
            <div class="hero-content">
              <div class="status-badge" [style.background-color]="getStatusColor(liveClass.status)">
                {{ liveClass.status | titlecase }}
              </div>
              <h1 class="class-title">{{ liveClass.title }}</h1>
              <div class="class-meta">
                <span class="category">{{ liveClass.category }}</span>
                <span class="difficulty" [style.color]="getDifficultyColor(liveClass.difficulty)">
                  {{ liveClass.difficulty }}
                </span>
                <span class="duration">{{ formatDuration(liveClass.duration) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Class Info Bar -->
      <div class="class-info-bar">
        <div class="schedule-info">
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>{{ formatDate(liveClass.scheduledDate) }}</span>
          </div>
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
            <span>{{ formatTime(liveClass.scheduledTime) }}</span>
          </div>
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>{{ liveClass.currentParticipants }}/{{ liveClass.maxParticipants }} participants</span>
          </div>
        </div>
        <div class="price-info" *ngIf="liveClass.price > 0">
          <span class="price">₱{{ liveClass.price | number }}</span>
        </div>
        <div class="free-badge" *ngIf="liveClass.price === 0">
          Free
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <!-- Mentee Actions -->
        <ng-container *ngIf="userRole === 'mentee'">
          <button 
            *ngIf="canEnroll() && !isEnrolled()" 
            class="btn btn-primary" 
            (click)="enrollInClass()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <line x1="19" y1="8" x2="19" y2="14"></line>
              <line x1="22" y1="11" x2="16" y2="11"></line>
            </svg>
            {{ liveClass.price > 0 ? 'Enroll Now' : 'Join Free' }}
          </button>
          <button 
            *ngIf="canJoin()" 
            class="btn btn-success" 
            (click)="joinClass()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            Join Live Class
          </button>
          <div *ngIf="isEnrolled()" class="enrolled-status">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
            <span>Enrolled</span>
          </div>
        </ng-container>

        <!-- Mentor Actions -->
        <ng-container *ngIf="userRole === 'mentor'">
          <button 
            *ngIf="canEdit()" 
            class="btn btn-secondary" 
            (click)="editClass()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit Class
          </button>
          <button 
            *ngIf="canJoin()" 
            class="btn btn-success" 
            (click)="joinClass()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            Start/Join Class
          </button>
          <button 
            *ngIf="canDelete()" 
            class="btn btn-danger" 
            (click)="deleteClass()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
            </svg>
            Delete Class
          </button>
        </ng-container>
      </div>

      <!-- Instructor Info -->
      <div class="instructor-section">
        <div class="instructor-card">
          <img 
            [src]="getSafeImageUrl(liveClass.instructor.avatar, 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face&auto=format&q=80')"
            [alt]="liveClass.instructor.name"
            class="instructor-avatar loading"
            (load)="onImageLoad($event)"
            (loadstart)="onImageLoadStart($event)"
            (error)="onImageError($event)">
          <div class="instructor-info">
            <h3>{{ liveClass.instructor.name }}</h3>
            <div class="instructor-stats">
              <div class="stat">
                <span class="rating">★ {{ liveClass.instructor.rating }}</span>
              </div>
              <div class="stat">
                <span>{{ liveClass.instructor.totalStudents | number }} students</span>
              </div>
            </div>
            <p class="instructor-bio">{{ liveClass.instructor.bio }}</p>
          </div>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <div class="tabs-container">
        <div class="tabs">
          <button 
            class="tab"
            [class.active]="activeTab === 'overview'"
            (click)="switchTab('overview')">
            Overview
          </button>
          <button 
            class="tab"
            [class.active]="activeTab === 'agenda'"
            (click)="switchTab('agenda')">
            Agenda
          </button>
          <button 
            class="tab"
            [class.active]="activeTab === 'materials'"
            (click)="switchTab('materials')">
            Materials
          </button>
          <button 
            class="tab"
            [class.active]="activeTab === 'students'"
            (click)="switchTab('students')"
            *ngIf="userRole === 'mentor'">
            Students ({{ liveClass.registeredStudents.length }})
          </button>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="overview-content">
          <div class="description-section">
            <h3>About This Class</h3>
            <p>{{ liveClass.description }}</p>
          </div>

          <div class="topics-section">
            <h3>What You'll Learn</h3>
            <div class="topics-grid">
              <div *ngFor="let topic of liveClass.topics" class="topic-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20,6 9,17 4,12"></polyline>
                </svg>
                <span>{{ topic }}</span>
              </div>
            </div>
          </div>

          <div class="requirements-section" *ngIf="liveClass.requirements && liveClass.requirements.length > 0">
            <h3>Requirements</h3>
            <ul class="requirements-list">
              <li *ngFor="let requirement of liveClass.requirements">{{ requirement }}</li>
            </ul>
          </div>
        </div>

        <!-- Agenda Tab -->
        <div *ngIf="activeTab === 'agenda'" class="agenda-content">
          <h3>Class Agenda</h3>
          <div class="agenda-timeline">
            <div *ngFor="let item of liveClass.agenda" class="agenda-item">
              <div class="agenda-time">{{ formatDuration(item.duration) }}</div>
              <div class="agenda-details">
                <h4>{{ item.title }}</h4>
                <p>{{ item.description }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Materials Tab -->
        <div *ngIf="activeTab === 'materials'" class="materials-content">
          <h3>Class Materials</h3>
          <div class="materials-list">
            <div *ngFor="let material of liveClass.materials" class="material-item">
              <div class="material-icon">{{ getMaterialIcon(material.type) }}</div>
              <div class="material-info">
                <h4>{{ material.title }}</h4>
                <p *ngIf="material.description">{{ material.description }}</p>
                <div class="material-meta">
                  <span class="material-type">{{ material.type | titlecase }}</span>
                  <span *ngIf="material.size" class="material-size">{{ material.size }}</span>
                </div>
              </div>
              <div class="material-actions">
                <button 
                  *ngIf="material.type === 'link'" 
                  class="btn btn-sm btn-secondary"
                  (click)="openMaterialLink(material)">
                  Open
                </button>
                <button 
                  *ngIf="material.type !== 'link'" 
                  class="btn btn-sm btn-secondary"
                  (click)="downloadMaterial(material)">
                  Download
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Students Tab (Mentor Only) -->
        <div *ngIf="activeTab === 'students' && userRole === 'mentor'" class="students-content">
          <div class="students-header">
            <h3>Registered Students</h3>
            <div class="students-stats">
              <span>{{ liveClass.registeredStudents.length }} enrolled</span>
              <span>{{ liveClass.maxParticipants - liveClass.currentParticipants }} spots remaining</span>
            </div>
          </div>

          <div class="students-list">
            <div *ngFor="let student of liveClass.registeredStudents" class="student-item">
              <img 
                [src]="getSafeImageUrl(student.avatar, 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face&auto=format&q=80')"
                [alt]="student.name"
                class="student-avatar loading"
                (load)="onImageLoad($event)"
                (loadstart)="onImageLoadStart($event)"
                (error)="onImageError($event)">
              
              <div class="student-info">
                <h4>{{ student.name }}</h4>
                <p>{{ student.email }}</p>
                <p *ngIf="student.school" class="school">{{ student.school }}</p>
                <span class="registration-date">
                  Registered {{ formatDate(student.registeredAt) }}
                </span>
              </div>

              <div class="student-status">
                <span 
                  class="payment-status"
                  [style.color]="getPaymentStatusColor(student.paymentStatus)">
                  {{ student.paymentStatus | titlecase }}
                </span>
                <span *ngIf="student.attended" class="attended-badge">Attended</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
